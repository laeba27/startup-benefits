# Backend Structure & API Documentation

## Table of Contents
1. [Project Structure](#project-structure)
2. [API Endpoints](#api-endpoints)
3. [Testing with Postman](#testing-with-postman)
4. [Creating New APIs](#creating-new-apis)

---

## Project Structure

### Directory Layout

```
backend/
├── src/
│   ├── app.ts                          # Express app setup with middleware
│   ├── server.ts                       # Entry point - starts server
│   │
│   ├── config/
│   │   └── database.ts                 # MongoDB connection
│   │
│   ├── models/                         # Database schemas
│   │   ├── User.model.ts               # User schema (email, profile, verification)
│   │   ├── Deal.model.ts               # Deal schema (startup benefits)
│   │   └── Claim.model.ts              # Claim schema (user claimed deals)
│   │
│   ├── controllers/                    # Business logic
│   │   ├── auth.controller.ts          # Authentication & profile logic
│   │   ├── deal.controller.ts          # Deal endpoints logic
│   │   ├── claim.controller.ts         # Claim endpoints logic
│   │   └── dashboard.controller.ts     # Dashboard data logic
│   │
│   ├── routes/                         # API route definitions
│   │   ├── auth.routes.ts              # /api/auth/* routes
│   │   ├── deal.routes.ts              # /api/deals/* routes
│   │   ├── claim.routes.ts             # /api/claims/* routes
│   │   └── dashboard.routes.ts         # /api/dashboard/* routes
│   │
│   ├── middleware/                     # Custom middleware
│   │   ├── auth.middleware.ts          # JWT verification
│   │   ├── error.middleware.ts         # Error handling
│   │   ├── validate.middleware.ts      # Request validation
│   │   └── notFound.middleware.ts      # 404 handling
│   │
│   ├── utils/
│   │   ├── AppError.ts                 # Custom error class
│   │   ├── asyncHandler.ts             # Async/await wrapper
│   │   └── emailService.ts             # Email sending utility
│   │
│   └── scripts/
│       └── seedDeals.ts                # Database seeding script
│
├── dist/                               # Compiled JavaScript (auto-generated)
├── .env                                # Environment variables
├── package.json                        # Dependencies & scripts
└── tsconfig.json                       # TypeScript config
```

### Key Files Explanation

| File | Purpose |
|------|---------|
| `src/app.ts` | Configures Express, adds middleware (CORS, body parser, error handler), registers routes |
| `src/server.ts` | Starts the server on port 8080, connects to MongoDB |
| `src/models/*.ts` | Defines MongoDB schemas using Mongoose |
| `src/controllers/*.ts` | Contains business logic - processes requests and returns responses |
| `src/routes/*.ts` | Defines API endpoints and maps them to controllers |
| `src/middleware/auth.middleware.ts` | Verifies JWT tokens on protected routes |

### Folder Structure Decision

- **`src/`** → Your source code (TypeScript)
- **`dist/`** → Compiled JavaScript (auto-generated by TypeScript compiler)
  - Created when you run `npm run build`
  - Used in production (`npm start`)
  - You don't edit this folder manually

---

## API Endpoints

### Base URL
```
http://localhost:8080
```

### Health Check
```http
GET /health
```
**Response:**
```json
{
  "status": "OK",
  "timestamp": "2025-01-29T10:30:00.000Z",
  "uptime": 3600
}
```

---

### Authentication Endpoints (`/api/auth`)

#### 1. Register User
```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "name": "John Doe",
  "phone": "1234567890"
}
```
**Response (201):**
```json
{
  "success": true,
  "message": "User registered successfully. Verification email sent.",
  "data": {
    "userId": "507f1f77bcf86cd799439011",
    "email": "user@example.com"
  }
}
```

#### 2. Send Magic Link
```http
POST /api/auth/magic-link
Content-Type: application/json

{
  "email": "user@example.com"
}
```
**Response (200):**
```json
{
  "success": true,
  "message": "Magic link sent to your email"
}
```

#### 3. Verify Magic Link
```http
POST /api/auth/verify
Content-Type: application/json

{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
**Response (200):**
```json
{
  "success": true,
  "message": "Email verified successfully",
  "data": {
    "token": "new_jwt_token_here",
    "user": {
      "id": "507f1f77bcf86cd799439011",
      "email": "user@example.com",
      "isVerified": true
    }
  }
}
```

#### 4. Get Current User Profile
```http
GET /api/auth/profile
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "507f1f77bcf86cd799439011",
      "email": "user@example.com",
      "isVerified": true,
      "profile": {
        "name": "John Doe",
        "phone": "1234567890",
        "company": "Tech Corp",
        "role": "Founder"
      }
    }
  }
}
```

#### 5. Update User Profile
```http
PUT /api/auth/profile
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "name": "John Doe",
  "phone": "9876543210",
  "company": "New Company",
  "role": "CTO"
}
```
**Response (200):**
```json
{
  "success": true,
  "message": "Profile updated successfully"
}
```

#### 6. Logout
```http
POST /api/auth/logout
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

### Deals Endpoints (`/api/deals`)

#### 1. Get All Deals (Paginated)
```http
GET /api/deals?page=1&limit=10&search=github&category=Developer%20Tools
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "deals": [
      {
        "_id": "507f1f77bcf86cd799439011",
        "name": "GitHub Pro",
        "description": "Professional GitHub features",
        "company": "GitHub",
        "value": 200,
        "discount": 50,
        "category": "Developer Tools",
        "expirationDate": "2025-12-31T23:59:59.000Z"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalDeals": 50,
      "hasNextPage": true
    }
  }
}
```

#### 2. Get Single Deal
```http
GET /api/deals/507f1f77bcf86cd799439011
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "GitHub Pro",
    "description": "Professional GitHub features for startups",
    "company": "GitHub",
    "value": 200,
    "discount": 50,
    "category": "Developer Tools",
    "logo": "https://...",
    "link": "https://github.com/startup",
    "couponCode": "STARTUP50",
    "isRestricted": false,
    "expirationDate": "2025-12-31T23:59:59.000Z"
  }
}
```

#### 3. Get Deal Categories
```http
GET /api/deals/categories
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "categories": [
      "Developer Tools",
      "Analytics",
      "Design",
      "Marketing",
      "Productivity",
      "Cloud Services",
      "Security",
      "Databases",
      "DevOps",
      "Other"
    ]
  }
}
```

---

### Dashboard Endpoints (`/api/dashboard`) ⚠️ Requires Authentication

#### 1. Get Dashboard Data
```http
GET /api/dashboard
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "profile": {
      "_id": "507f1f77bcf86cd799439011",
      "name": "John Doe",
      "email": "user@example.com",
      "company": "Tech Corp",
      "role": "Founder",
      "isVerified": true
    },
    "stats": {
      "totalClaimsClaimed": 5,
      "activeDeals": 15,
      "pendingClaims": 2,
      "totalSavings": 5000,
      "availableDeals": 50
    },
    "recentActivity": []
  }
}
```

#### 2. Get User Profile (Dashboard)
```http
GET /api/dashboard/profile
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "John Doe",
    "email": "user@example.com",
    "phone": "1234567890",
    "company": "Tech Corp",
    "role": "Founder",
    "isVerified": true
  }
}
```

#### 3. Update Profile (Dashboard)
```http
PUT /api/dashboard/profile
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "name": "John Doe",
  "phone": "9876543210",
  "company": "New Company",
  "role": "CTO"
}
```
**Response (200):**
```json
{
  "success": true,
  "message": "Profile updated successfully"
}
```

#### 4. Get User Claims
```http
GET /api/dashboard/claims?status=active&sortBy=createdAt
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "claims": [
      {
        "_id": "507f1f77bcf86cd799439011",
        "dealId": "507f1f77bcf86cd799439012",
        "dealName": "GitHub Pro",
        "status": "active",
        "claimedDate": "2025-01-20T10:30:00.000Z",
        "expiresAt": "2025-12-31T23:59:59.000Z"
      }
    ]
  }
}
```

#### 5. Get Dashboard Stats
```http
GET /api/dashboard/stats
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "totalClaimsClaimed": 5,
    "activeDeals": 15,
    "pendingClaims": 2,
    "totalSavings": 5000
  }
}
```

---

### Claims Endpoints (`/api/claims`) ⚠️ Requires Authentication

#### 1. Claim a Deal
```http
POST /api/claims
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "dealId": "507f1f77bcf86cd799439011"
}
```
**Response (201):**
```json
{
  "success": true,
  "message": "Deal claimed successfully",
  "data": {
    "claimId": "507f1f77bcf86cd799439013",
    "dealId": "507f1f77bcf86cd799439011",
    "status": "active",
    "claimedDate": "2025-01-29T10:30:00.000Z"
  }
}
```

#### 2. Get User's Claims
```http
GET /api/claims
Authorization: Bearer {JWT_TOKEN}
```
**Response (200):**
```json
{
  "success": true,
  "data": {
    "claims": [
      {
        "_id": "507f1f77bcf86cd799439013",
        "dealId": "507f1f77bcf86cd799439011",
        "dealName": "GitHub Pro",
        "status": "active",
        "claimedDate": "2025-01-20T10:30:00.000Z"
      }
    ]
  }
}
```

---

## Testing with Postman

### Step 1: Import Environment Variables

1. Open Postman
2. Click **Environments** (gear icon)
3. Create new environment called "Startup Benefits"
4. Add these variables:

| Variable | Initial Value | Current Value |
|----------|--------------|---------------|
| `BASE_URL` | http://localhost:8080 | http://localhost:8080 |
| `JWT_TOKEN` | (leave empty) | (will be filled after login) |

### Step 2: Create a Collection

1. Click **Create** → **Collection** → "Startup Benefits API"

### Step 3: Test Endpoints

#### Test 1: Send Magic Link
1. Create new request in collection
2. Method: `POST`
3. URL: `{{BASE_URL}}/api/auth/magic-link`
4. Headers:
   ```
   Content-Type: application/json
   ```
5. Body (raw):
   ```json
   {
     "email": "test@example.com"
   }
   ```
6. Click **Send**
7. Check email for magic link (in development, check console logs)

#### Test 2: Verify Magic Link
1. Get the JWT token from magic link response
2. Create new request
3. Method: `POST`
4. URL: `{{BASE_URL}}/api/auth/verify`
5. Headers:
   ```
   Content-Type: application/json
   ```
6. Body:
   ```json
   {
     "token": "paste_jwt_token_here"
   }
   ```
7. Click **Send**
8. Copy the `token` from response

#### Test 3: Set JWT Token in Environment
1. Go to Environment settings
2. Set `JWT_TOKEN` = the token you received
3. Save

#### Test 4: Get Protected Endpoint
1. Create new request
2. Method: `GET`
3. URL: `{{BASE_URL}}/api/auth/profile`
4. Headers:
   ```
   Authorization: Bearer {{JWT_TOKEN}}
   ```
5. Click **Send**

#### Test 5: Get All Deals
1. Create new request
2. Method: `GET`
3. URL: `{{BASE_URL}}/api/deals?page=1&limit=10`
4. Click **Send** (no auth needed)

#### Test 6: Get Dashboard Data
1. Create new request
2. Method: `GET`
3. URL: `{{BASE_URL}}/api/dashboard`
4. Headers:
   ```
   Authorization: Bearer {{JWT_TOKEN}}
   ```
5. Click **Send**

#### Test 7: Update Profile
1. Create new request
2. Method: `PUT`
3. URL: `{{BASE_URL}}/api/dashboard/profile`
4. Headers:
   ```
   Authorization: Bearer {{JWT_TOKEN}}
   Content-Type: application/json
   ```
5. Body:
   ```json
   {
     "name": "John Doe",
     "phone": "1234567890",
     "company": "Startup Inc",
     "role": "Founder"
   }
   ```
6. Click **Send**

#### Test 8: Claim a Deal
1. Create new request
2. Method: `POST`
3. URL: `{{BASE_URL}}/api/claims`
4. Headers:
   ```
   Authorization: Bearer {{JWT_TOKEN}}
   Content-Type: application/json
   ```
5. Body:
   ```json
   {
     "dealId": "507f1f77bcf86cd799439011"
   }
   ```
6. Click **Send**

---

## Creating New APIs

### Step-by-Step Guide to Add a New API Endpoint

Let's say you want to create a `POST /api/feedback` endpoint.

### Step 1: Create the Model (if needed)

Create `src/models/Feedback.model.ts`:

```typescript
import mongoose, { Schema, Document } from 'mongoose';

export interface IFeedback extends Document {
  userId: string;
  message: string;
  rating: number;
  type: 'bug' | 'feature' | 'general';
  createdAt?: Date;
  updatedAt?: Date;
}

const feedbackSchema = new Schema<IFeedback>(
  {
    userId: {
      type: String,
      required: true,
    },
    message: {
      type: String,
      required: true,
      maxlength: 1000,
    },
    rating: {
      type: Number,
      min: 1,
      max: 5,
      required: true,
    },
    type: {
      type: String,
      enum: ['bug', 'feature', 'general'],
      default: 'general',
    },
  },
  {
    timestamps: true,
  }
);

export const Feedback = mongoose.model<IFeedback>('Feedback', feedbackSchema);
```

### Step 2: Create the Controller

Create `src/controllers/feedback.controller.ts`:

```typescript
import { Response } from 'express';
import { Feedback } from '../models/Feedback.model';

interface AuthRequest extends Request {
  user: {
    id: string;
    email: string;
  };
}

// Create feedback
export const createFeedback = async (req: AuthRequest, res: Response) => {
  try {
    const { message, rating, type } = req.body;

    // Validation
    if (!message || message.trim().length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Message is required',
      });
    }

    if (rating < 1 || rating > 5) {
      return res.status(400).json({
        success: false,
        message: 'Rating must be between 1 and 5',
      });
    }

    // Create feedback
    const feedback = await Feedback.create({
      userId: req.user.id,
      message: message.trim(),
      rating,
      type: type || 'general',
    });

    res.status(201).json({
      success: true,
      message: 'Feedback submitted successfully',
      data: feedback,
    });
  } catch (error) {
    console.error('Error creating feedback:', error);
    res.status(500).json({
      success: false,
      message: 'Error submitting feedback',
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
};

// Get all feedback (admin only)
export const getAllFeedback = async (req: Request, res: Response) => {
  try {
    const feedback = await Feedback.find().sort({ createdAt: -1 });

    res.status(200).json({
      success: true,
      data: feedback,
    });
  } catch (error) {
    console.error('Error fetching feedback:', error);
    res.status(500).json({
      success: false,
      message: 'Error fetching feedback',
    });
  }
};
```

### Step 3: Create the Routes

Create `src/routes/feedback.routes.ts`:

```typescript
import express from 'express';
import { body } from 'express-validator';
import { validateRequest } from '../middleware/validate.middleware';
import { authenticateToken } from '../middleware/auth.middleware';
import { createFeedback, getAllFeedback } from '../controllers/feedback.controller';

const router = express.Router();

// @route   POST /api/feedback
// @desc    Submit feedback
// @access  Private (authenticated users)
router.post(
  '/',
  authenticateToken,
  [
    body('message')
      .trim()
      .isLength({ min: 5, max: 1000 })
      .withMessage('Message must be between 5 and 1000 characters'),
    body('rating')
      .isInt({ min: 1, max: 5 })
      .withMessage('Rating must be between 1 and 5'),
  ],
  validateRequest,
  createFeedback
);

// @route   GET /api/feedback
// @desc    Get all feedback (admin only)
// @access  Public (for demo, add admin check later)
router.get('/', getAllFeedback);

export default router;
```

### Step 4: Register the Routes in `app.ts`

Edit `src/app.ts`:

```typescript
import feedbackRoutes from './routes/feedback.routes';

// ... other route imports ...

// API routes
app.use('/api/auth', authRoutes);
app.use('/api/deals', dealRoutes);
app.use('/api/claims', claimRoutes);
app.use('/api/dashboard', dashboardRoutes);
app.use('/api/feedback', feedbackRoutes);  // Add this line

// ... rest of app.ts ...
```

### Step 5: Test in Postman

1. Create new request
2. Method: `POST`
3. URL: `{{BASE_URL}}/api/feedback`
4. Headers:
   ```
   Authorization: Bearer {{JWT_TOKEN}}
   Content-Type: application/json
   ```
5. Body:
   ```json
   {
     "message": "Great platform! Would love to see more deals.",
     "rating": 5,
     "type": "feature"
   }
   ```
6. Click **Send**

---

## Error Handling Standards

All errors follow this format:

```json
{
  "success": false,
  "message": "Error description",
  "error": "Detailed error (development only)"
}
```

### Common HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | OK - Request successful |
| 201 | Created - Resource created successfully |
| 400 | Bad Request - Invalid input |
| 401 | Unauthorized - Missing/invalid JWT token |
| 404 | Not Found - Resource doesn't exist |
| 500 | Server Error - Unexpected error |

---

## Authentication

All protected endpoints require JWT token in header:

```
Authorization: Bearer {JWT_TOKEN}
```

### Getting JWT Token

1. User calls `/api/auth/magic-link` with email
2. Email contains magic link with JWT token
3. User calls `/api/auth/verify` with token
4. Server returns JWT token for future requests
5. Use this token in `Authorization` header

---

## Tips for Development

1. **Use Postman** for quick API testing
2. **Save responses** as examples for reference
3. **Test all edge cases** (missing fields, invalid data, etc.)
4. **Check MongoDB** with MongoDB Compass to see actual data
5. **Read error messages** carefully - they guide you to the issue
6. **Use `console.log`** in controllers for debugging
